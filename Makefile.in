# Makefile for the Anna interpreter
#
# Copyright 2011 Axel Liljencrantz
#

# Choose the compiler. Probably has to be a modern GCC version, since
# Anna uses a few GCC extensions.
CC := @CC@
ANNABIND := ANNA_BOOTSTRAP_DIRECTORY=./bootstrap bin/anna util/annabind.anna
ANNADOC := ANNA_BOOTSTRAP_DIRECTORY=./bootstrap bin/anna util/annadoc.anna
INSTALL := @INSTALL@
PACKAGE_TARNAME = @PACKAGE_TARNAME@

#
# Installation directories
#

prefix = $(DESTDIR)@prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
datadir = @datadir@
annadatadir = $(datadir)/anna
bootstrapdir = $(annadatadir)/bootstrap
bindir = @bindir@
mandir = @mandir@
docdir = @docdir@
localedir = @localedir@
libdir = ${prefix}/lib/anna

# Uncomment to get output suitable for gcov
COV_FLAGS := #--coverage

# The no-gcse flag removes the global common sub-expression
# optimization. This optimization interacts badly with computed gotos,
# a feature used heavily in the main interpreter loop. Dropping this
# optimization increases overall performance slightly. Unfortunatly,
# with lto, there does not seem to be any way to drop this flag only
# for one function or one compilation unit.
PROF_FLAGS := -g  #-flto -O3 -fuse-linker-plugin -fno-gcse

# CFLAGS_NOWARN consists of all cflags not related to warnings. Used
# for compiling some code that we can't easily fix minor problems in,
# e.g. autogenerated code and code from external sources.
CFLAGS_NOWARN := @CFLAGS@ $(PROF_FLAGS) $(COV_FLAGS) -I include -I . \
-DANNA_BOOTSTRAP_DIRECTORY=L\"$(bootstrapdir)\" -DANNA_LIB_DIR=L\"$(libdir)\"

# Full cflags, including warnings 
CFLAGS := $(CFLAGS_NOWARN) @CFLAGS_WARN@

ANNA_LIB_OBJS := src/lib/lang/lang.o src/lib/reflection/reflection.o	\
src/lib/parser/parser.o src/lib/ctime.o src/lib/debug/debug.o src/lib/mp/mp.o

# All object files used by the main anna binary
ANNA_OBJS := $(ANNA_LIB_OBJS) src/dtoa.o src/anna.o src/node/node.o	\
src/macro.o src/stack.o autogen/lex.o autogen/yacc.o src/type.o		\
src/function.o src/util/util.o src/module.o src/vm.o src/alloc/alloc.o	\
src/compile.o src/wutil.o src/common.o src/attribute.o src/object.o	\
src/error.o src/parse.o src/invoke.o src/fallback.o

LDFLAGS := @LIBS@ @LDFLAGS@ -rdynamic $(PROF_FLAGS) $(COV_FLAGS)

PROGRAMS := bin/anna 

ANNA_INTERNAL_BINDINGS := lib/unix.so lib/getText.so lib/readLine.so
ANNA_EXTERNAL_BINDINGS := lib/curses.so lib/math.so

all: $(PROGRAMS) bindings documentation $(ANNA_EXTERNAL_BINDINGS)
.PHONY: all

bindings: $(ANNA_EXTERNAL_BINDINGS) 
.PHONY: bindings

internal_bindings:
	for i in internalBindings/*.bind; do $(ANNABIND) $$i > lib/$$(basename $$i .bind).c; done
.PHONY: internal_bindings

lib/%.c: bindings/%.bind bin/anna
	$(ANNABIND) bindings/$*.bind  > $@ || rm $@

#########################################################
#            BEGIN DEPENDENCY TRACKING                  #
#    See "Recursive make considered harmful" for an     #
#          explanation of how this code works.          #
#########################################################
%.d: %.c
	@printf "%s" $@ " " >$@; $(CC) -I include -I . -MT $(@:.d=.o)  -MM -MG $*.c >> $@ || rm $@ 

ifneq "$(MAKECMDGOALS)" "clean"
-include $(ANNA_OBJS:.o=.d)
endif
#########################################################
#             END DEPENDENCY TRACKING                   #
#########################################################

install: all documentation
	$(INSTALL) -m 755 -d $(bindir)
	for i in $(PROGRAMS); do\
		$(INSTALL) -m 755 $$i $(bindir) ; \
	done;
	$(INSTALL) -m 755 util/annabind.anna $(bindir)/annabind
	$(INSTALL) -m 755 -d $(libdir)
	$(INSTALL) -m 755 -d $(bootstrapdir)
	$(INSTALL) -m 644 lib/*.anna lib/*.so $(libdir)
	$(INSTALL) -m 644 bootstrap/*.anna $(bootstrapdir)
	for i in `find include -type d`; do\
		$(INSTALL) -m 755 -d $(prefix)/$$i; \
	done;
	for i in `find include -name '[^.#]*.h'`; do\
		$(INSTALL) -m 644 $$i $(prefix)/$$i; \
	done;
	for i in `cd documentation; find . -name '[^.#]*.html' -o -name '[^.#]*.js' -o -name '[^.#]*.css'`; do\
		if test -f "documentation/$$i"; then $(INSTALL) -D -m 644 "documentation/$$i" $(docdir)/$$i; fi; \
	done;

.PHONY: install

# make uninstall removes any anna-related directories.  It doesn't try to not
# uninstall any Anna libraries that have been installed by third parties.
# If you want proper uninstall support, better use a real package manager. 
uninstall: 
	-for i in $(PROGRAMS); do \
		rm -f $(prefix)/$$i; \
	done;
	-rm $(bindir)/annabind
	-rm $(libdir)/*
	-rmdir $(libdir)
	-rm $(bootstrapdir)/*
	-rmdir $(bootstrapdir)
	-rmdir $(annadatadir)
	-rmdir $(bindir)
	-rm -rf $(prefix)/include/anna/
	-rm -rf $(docdir)/
.PHONY: uninstall

lib/%.o: lib/%.c
	$(CC) -fPIC -c lib/$*.c -o lib/$*.o $(CFLAGS_NOWARN)

%.so: %.o
	$(CC) -shared $*.o -o $@ $(LDFLAGS) 

bin/anna: $(ANNA_OBJS) $(ANNA_INTERNAL_BINDINGS)
	$(CC) $(ANNA_OBJS) -o $@ $(LDFLAGS) 

autogen/lex.c: src/lex.y 
	flex -CFe -8 -oautogen/lex.c -Panna_lex_ src/lex.y 

autogen/lex.h: autogen/lex.c

autogen/yacc.c: src/yacc.y
	bison -d src/yacc.y -o autogen/yacc.c -v -p anna_yacc_

autogen/yacc.h: autogen/yacc.c

autogen/%.c: bin/make_%.sh
	./bin/make_$*.sh >autogen/$*.c

# These files consist of either external or autogenerated code, not
# much to do about the warnings, so we silence them...
src/dtoa.o: src/dtoa.c
	$(CC) $(CFLAGS_NOWARN) -c src/dtoa.c -o src/dtoa.o -DIEEE_8087 -DLong=int

autogen/lex.o: autogen/lex.c 
	$(CC) $(CFLAGS_NOWARN) -c autogen/lex.c -o autogen/lex.o

check: test
.PHONY: check

documentation: documentation/api

documentation/api: bin/anna lib/*.anna $(ANNA_EXTERNAL_BINDINGS) util/documentation/*.html bootstrap/*.anna util/annadoc.anna
	$(ANNADOC) && touch documentation/api

test: bin/anna
	time ./bin/anna_tests.sh
.PHONY: test

clean:
	rm -f src/*.o src/*.d src/*/*.o src/*/*/*.d src/*/*/*.o src/*/*.d autogen/*.o autogen/*.c autogen/*.h autogen/*.d autogen/*.output *.gcov *.gcda *.gcno bin/anna gmon.out lib/*.so lib/*.o lib/*.d lib/*.o documentation/index.html $(ANNA_EXTERNAL_BINDINGS:.so=.c)
	-rm -r documentation/api
.PHONY: clean

distclean: clean
	rm -f config.status config.log include/anna/config.h Makefile
.PHONY: distclean
